# Divinum Officium Project – Architecture and Data Flow

Divinum Officium is an open-source web project (written primarily in Perl 5) that provides the traditional Roman Breviary (Divine Office) and Missal (Mass) in multiple languages. The code is structured to generate HTML pages for the breviary (“Horas”) and the missal, using a large collection of data files that encode the liturgical texts and calendar rules. The project’s technical documentation explicitly encourages others “to write his/her own system, using whatever he/she wants from these ideas,” and provides an overview of how Divinum Officium (the Office) and Sancta Missa (the Mass) are internally structured [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=This%20part%20of%20the%20help,others%20to%20the%20same%20ideas). Below is a detailed breakdown of how the system works, focusing on the liturgical calendar logic, the assembly of the Horas (Liturgy of the Hours), and the Missal.

## Data Files and Repository Structure

All liturgical texts and rubrical data are stored in plain-text “.txt” files organized into directories by language and by liturgical sections. In the project’s repository (the /web subdirectory), the top-level folders correspond to languages (Latin, English, French, etc.). Each language folder then contains standard subfolders reflecting parts of the breviary books (and similarly for the missal), such as Psalterium, Tempora, Sancti, Commune, etc [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20databases%20are%20files%2C%20which,effect%20the%20appearance%20of%20text). 
For example, web/www/horas/Latin/Tempora/Adv1-0.txt might contain the office for the 1st Sunday of Advent in Latin, and .../English/Tempora/Adv1-0.txt the corresponding English text. All files use UTF-8 encoding [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20databases%20are%20files%2C%20which,effect%20the%20appearance%20of%20text)

- Language fallback: If a file is missing for a given modern language, the program automatically falls back to the English text (with a special case that a “hyphenated” language like Polski-Newer will first fall back to its base language Polski) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20top%20level%20folders%20are,folder%20of%20that%20language%20first). This means the English files serve as a default for any untranslated content.

- File format (hash sections): Each liturgical text file is divided into sections marked by a key in square brackets on its own line (e.g. [Ant Matutinum], [Capitulum Nona], [Lectio93], etc.), followed by the content of that section [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20files%20itself%20usually%20are,Capitulum%20Nona%5D%2C%20etc). In the code, these files are parsed such that each bracketed section becomes an entry in a hash/dictionary, with the bracketed title as the key and the following lines as its value [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20files%20itself%20usually%20are,Capitulum%20Nona%5D%2C%20etc). For example, a saint’s proper might have sections like [Name], [Rank], [Ant 1] (antiphon for Benedictus at Lauds), [Lectio1] (first lesson at Matins), etc. These hash elements are later accessed by the program to assemble the hour. “The key is enclosed within square brackets [ ... ] followed by the body of the element. For instance, [Ant 2] refers to the Benedictus antiphon at Lauds...” [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20files%20itself%20usually%20are,Capitulum%20Nona%5D%2C%20etc). Notably, the Latin versions of files carry the authoritative metadata (like ranks), and in other languages anything after the first ;; in a [Rank] line is ignored (it uses the Latin rank info) [source](https://github.com/DivinumOfficium/divinum-officium/discussions/3993#:~:text=for%20decision%20making%20on%20the,to%20be%20stacked%20on%20Latin).

- Ordinarium and Psalter: Aside from the proper files, there are special directories for common and ordinary texts:

    - Ordinarium – Contains the “skeleton” of each canonical hour’s structure. Each hour of the Divine Office has a template file with lines beginning with # that define the sequence of prayers/readings, etc., for that hour [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,usually%20printed%20in%20the%20Ordinarium). (Matins has two files, one being a special case for Epiphany Matins.) These files are not parsed into hashes but are read line by line to structure the output [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,Special%20characters). For example, Ordinarium/Laudes.txt might contain placeholders like # Hymnus, # Psalmi, # Capitulum, etc., which indicate where those elements should appear. The special characters (discussed below) in these files guide the code on how to fill in content.
    - Psalterium – Contains texts that are used across the liturgical year, such as common prayers (Prayers.txt), seasonal elements, and standard psalm schemes [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,216%20%3D%20Laudes%201). For instance, it holds the versicles, responses, and hymns that are used on ordinary weekdays or specific seasons, and instructions for seasonal variations (e.g. different Invitatory antiphons in Lent, etc.). It also includes files like “Psalmi” sets (e.g. Psalmi for Sunday Lauds vs ferial Lauds) and the Marian antiphons [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,216%20%3D%20Laudes%201). The 150 Psalms themselves (and biblical canticles) are typically in a separate Psalms folder, numbered by Psalm number or canticle number [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Prime%20%28Prima%20special%29.%20,in%20the%20Breviarum%20Romanum).

- Missal data: Similarly, the Mass propers are stored under web/www/missa/. Each language has a Missal subdirectory that likely mirrors the structure for the Office: e.g. Tempora (Proper of Time – Sundays and liturgical seasons), Sancti (Proper of Saints, keyed by date), Commune (Common Masses), and possibly an Ordo Missae or Ordinarium Missae for the fixed ordinary parts of the Mass. The project credits indicate that the Ordinary of the Mass and propers were sourced from various places [source](https://www.divinumofficium.com/www/horas/Help/credits.html#:~:text=Credits%20,from%20Iglesia%20de%20El) [source](https://www.divinumofficium.com/www/horas/Help/credits.html#:~:text=Parts%20of%20the%20Mass%20Ordinary,NSPJ%20w%20Bydgoszczy%20page). In practice, a Mass proper file (e.g. for a saint’s feast) would have sections like [Introit], [Collect] (often called Oratio), [Lectio] (Epistle/lesson), [Evangelium] (Gospel), [Offertorium], [Secreta] (Secret prayer), [Communio], [Postcommunio], etc. These follow the same bracketed format. If a feast is only commemorated (of simple rank), there may be a special abbreviated file (often with a cc suffix in the filename) containing just the parts needed for commemoration [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6001,11cc).
- for the Office this might have only the collect or a lesson; for the Mass it would have the orations used when commemorated.
- Special markup in texts: The content lines in the text files include special symbols to indicate formatting or dynamic content:
    - ! at start of a line marks it to be printed in red (usually rubrical instructions) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=antiphon%20within%20the%20same%20file,printout%20will%20set%20a%20border). 
    - v. and r. mark Versicle and Response openings (the letter following is rendered in large/small red capital) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,empty%20line%20without%20a%20border).
    - Certain standard liturgical cues like R., V., *, Ant., ℣., ℟. etc. are recognized and styled appropriately in output (often red) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=antiphon%20within%20the%20same%20file,will%20set%20a%20border%20separator).
    - A line containing only _ (underscore) represents a blank line that does not produce a visible border (used in formatting the HTML table cells) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=font.%20,line%20without%20a%20border%20separator).
    - A double line-break in the data signifies the end of a cell in the HTML table (the output is often tabulated with each prayer in its own cell) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,empty%20line%20without%20a%20border).
    - A ~ at the end of a line indicates that the line should join with the next line without a break (useful for long texts that should be one paragraph) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,text%20in%20small%20red%20font).
    - In Psalm files, text in parentheses is rendered in small red font (for “rubrical” portions of psalms) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%2A%20231,Each) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=separator.%20,line%20in%20psalms%20and%20readings), and a special symbol ‡ is used to mark flex/breakpoints in psalm verses for chanting (rendered as appropriate symbols like an asterisk or dagger) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%2A%20231,The%20naming).

Additionally, cross-references and dynamic content are embedded with symbols:

- @ denotes a reference to another section (possibly in another file). For example @Sancti/12-25:Capitulum Laudes means “pull the Lauds Capitulum from the file 12-25.txt in the Sancti folder (Christmas Day)” [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=psalmi%20option%20will%20expand%20it,letter%20as%20regular%20red%20font). A shorthand @:Ant 1 (with no filename) would reference a section within the same file [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=psalmi%20option%20will%20expand%20it,letter%20as%20regular%20red%20font). This mechanism prevents duplicating text by linking to a source text elsewhere.
- $ at the start of a line indicates a prayer taken from the Psalterium/Prayers.txt file (common prayers, like the Pater Noster, etc.) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=earlier.%20,will%20refer%20to%20the%20Lauds). This also is tied to an option in the interface: these can appear as links that open a popup if the user chooses a certain setting (the “psalmi” popup for common prayers).
- & calls an internal subroutine by name to insert dynamically computed text. For instance, some parts of the Office (like the doxology or certain seasonal phrases) might be generated by code. If the subroutine name starts with a lowercase letter, it will be expanded only when the psalmi (full text) option is on; if it starts with uppercase, it’s included in “All” mode only [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=represent%20a%20prayer%20found%20in,antiphon%20within%20the%20same%20file). These allow complex or conditional insertions that are easier to compute in code than encode in static text.

All these special characters are handled by the output-generation scripts (discussed below) to format the final HTML appropriately [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Special%20characters) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,the%20line%20with%20red%20font).

## Liturgical Calendar Logic (Date, Feast and Rank Determination)

At the core of Divinum Officium is the logic that determines what liturgical office or Mass corresponds to a given date (taking into account the selected calendar/rubrics version). This is implemented primarily in the horascommon.pl module, which “selects the current date, and the office for any given date, and provides rules for precedence.” [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Main%20Perl%20Scripts%20,and%20provides%20rules%20for%20precedence) In other words, this script figures out the complex rubrical rules of the traditional calendar: which feast is celebrated, which commemorations to include, and what transfers occur due to conflicts (occurrence/concurrence of feasts). The liturgical calendar data is encoded in a set of files under the Tabulae folder (Latin for “tables”) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,char):
- data.txt: This file maps the names of the various “Ordo” versions to short codes used in the data files [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,char). For example, it likely defines that “Divino Afflatu – 1910” corresponds to the code DA, “Rubrics 1960” to 1960, “Tridentine 1570” to 1570, etc. These codes appear in the transfer tables to indicate which rule applies to which liturgical regime [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6003,and%20does%20not%20get%20transferred). When a user selects a version (e.g. 1960 rubrics vs. 1570), the program knows which set of rules to apply by consulting data.txt.
- Kalendaria folder: These files contain the General Calendar (sanctoral) for each version. There are separate calendar files for each set of rubrics (e.g., 1570.txt, 1888.txt, 1906.txt, 1960.txt, etc.) listing the feasts on each date of the year [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=File%20,char). Each line assigns the feast(s) of a given date:
    - The format is MM-DD=<file>[~<comm_file>]=<feast name>=<rank>=.... For example, in the 1888.txt file, an entry is given as:
    ```
    01-11=01-11~01-11cc=Sexta die infra Octavam Epiphaniae=2=S. Hygini Papæ et Martyris=1=
    ```
    [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Meaning%20is%20explained%20in%20example,Divino%20Afflatu%20is%20used%20as).
This means January 11 has the office in file 01-11 (which is the 6th Day in the Octave of Epiphany, a feria) with a commemoration 01-11cc (a file for St. Hyginus, Pope & Martyr). The numbers 2 and 1 after the feast names are the ranks of each observance (here, “2” for the octave day, “1” for St. Hyginus) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Meaning%20is%20explained%20in%20example,Divino%20Afflatu%20is%20used%20as). Generally the higher number indicates higher rank (though the ranking system in the code is complex – see below). The part after the second = is informational text (feast names, etc.) and is “not used by the code itself.” [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=ones%20by%20way%20of%20commemoration,char) - the code relies on the file references and rank numbers rather than the human-readable Latin names.
```
If multiple observances are on the same day, they are separated by the `~` symbol in the second field (as in the example, the `~` separates the main office `01-11` and the commemorated feast `01-11cc`). The program will interpret everything before `~` as the **primary office** and anything after `~` as a **commemoration** to be included:contentReference[oaicite:39]{index=39}.
```
- Lines starting with * or #- in these files are comments or disabled entries [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,char).
- Tempora table: This is the “perpetual calendar” adjustments for the Proper of Time [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%2A%20%60Tempora%60%20perpetually,respectively). It accounts for the varying placement of Sundays and seasons (the Temporale) in different years. For example, how to handle the shifting of Epiphanytide and Septuagesima depending on when Easter falls. Entries here use the Dominical Letter system to specify certain years. For instance, from the technical example:

```
01-11=01-10~01-11cc;;1570 1888 1906
01-12=01-11;;1570 1888 1906
```
[source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6001,but%20without%20the%20aforementioned%20commemoration)

Under certain conditions (here for years with Sunday Letter A under those rubrics), the office of Jan 11 is taken from Jan 10 (5th day of Epiphany octave) with St. Hyginus still commemorated [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6001,but%20without%20the%20aforementioned%20commemoration); and Jan 12 similarly is taken from Jan 11 (6th day of octave) dropping the commemoration [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6001,but%20without%20the%20aforementioned%20commemoration). This is a case of transferring observances when Jan 6 (Epiphany) falls on a Sunday causing an octave day to be bumped.

Another example from Tempora:
```
03-20=03-19t;;1570
03-20=03-19;;1888 1960 DA M Newcal
```
[source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6003,and%20does%20not%20get%20transferred)

This shows that March 20 (St. Joseph’s day transferred) is handled differently depending on rubric versions if Easter falls on April 2 (Dominical Letter “D” scenario). Under 1570 rubrics, March 19’s feast is moved to 20 with a special “t” variant file (perhaps meaning “transferred” file) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6003,and%20does%20not%20get%20transferred). Under later rubrics (1888, 1960, Divino Afflatu, Monastic, “Newcal”), the normal March 19 file is used on March 20 [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6003,and%20does%20not%20get%20transferred). This reflects how St. Joseph’s feast might transfer if it conflicts with Palm Sunday or similar.

The Tempora rules thus override the normal calendar for specific year-dependent scenarios in the Proper of Time (Seasons).

- Transfer table: This table handles feasts that move based on the date of Easter (e.g., if a feast would normally fall in Holy Week or Easter week and needs to be anticipated or postponed). Entries are keyed by an index (often a letter or number) that corresponds to Easter dates. For example, 402.txt (ref in the docs) might correspond to the scenario of Easter falling on a specific date and how certain March feasts transfer [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Meaning%20is%20shown%20in%20examples,respectively). The format in Transfer files often is: <index>=<source_day>~<comm_source>;;<list of versions> indicating that on the indexed scenario, one day uses an office from another day (with possibly a commemoration) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6001,but%20without%20the%20aforementioned%20commemoration). The program will determine which “Easter index” applies for the current year (likely by computing the date of Easter) and then apply those transfers if needed.
- Stransfer table: Similar to Transfer but specifically for Scripture reading transfers at Matins [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6011,e). These are fine-grained rules (used mainly for Matins readings) that specify if lessons should be replaced, preceded, or appended by others in certain week configurations (often keyed to the Dominical letter as well). For instance, in the example:
```
11-19=114-2~R;;1570 1888 1906 DA
```
means if a certain Wednesday (Nov 19 with letter “e”) occurs under those rubrics, the scriptura lessons of that Feria are Replaced by those from Tuesday of the 4th week of November [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=11,of%20November%20as%20first%20lesson). Other codes like B (before) or A (after) indicate adding lessons before or after the day’s own lessons [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=11,of%20November%20as%20first%20lesson). This is quite specialized logic for handling how Matins readings are arranged when the calendar shifts (it ensures continuity of scripture readings when some days are impeded by feasts).

Using all these tables, horascommon.pl (and likely an analogous routine for the missal) performs the following general steps for a given date and chosen rubrics version:

1. Determine the Base Feast: It looks up the date in the appropriate Kalendaria file (for the selected version) to find the basic feast or ferial day and any commemoration [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Meaning%20is%20explained%20in%20example,Divino%20Afflatu%20is%20used%20as). If the date is in the Temporale (seasonal cycle), the file might be something like Adv3-0 (3rd Sunday of Advent) or Quad4-3 (Wednesday of 4th week of Lent), etc.; if it’s a saint’s day, the file would be in the Sancti folder (like 09-24 for Sept 24). The entry also gives an initial ranking for each observance.

2. Apply Transfers for Year: It checks if the date (or this feast) is affected by an entry in the Tempora or Transfer tables for the current year. This requires knowing the Dominical Letter of the year and the date of Easter. (The Dominical Letter is a traditional device (A–G) indicating which weekdays correspond to dates in a given year – the code likely computes it from the year and uses it to match Tempora rules that are indexed by letter [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6001,but%20without%20the%20aforementioned%20commemoration) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=11,of%20November%20as%20first%20lesson) ). It likely also computes an index for Easter (possibly how many days from March 22 or something) to select the correct Transfer sub-table. Based on these, horascommon might override the file name for the day’s office or add/remove commemorations as specified by the rules. For example, as shown above, Jan 11 might be replaced with Jan 10’s file in some years [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6001,but%20without%20the%20aforementioned%20commemoration), or St. Joseph’s feast moved to March 20 in certain years [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6003,and%20does%20not%20get%20transferred), etc. The code will swap in the alternate file names accordingly.

3. Determine Precedence and Commemorations: If multiple feasts fall on the same day (or a Sunday vs. feast conflict), the program uses each celebration’s Rank to decide which is kept as the main office and which (if any) is commemorated. Each liturgical file has a [Rank] section that encodes a numeric rank (and sometimes additional codes). Divinum Officium uses a numeric ranking system (1=highest or 1st class, etc., with steps and even decimal nuances) to consistently compare feasts [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=General%20Rank%20Duplex%20Semiduplex%20Simplex,3) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=II.%20classis%20%28Trid.%20pre,This%20and%20above%20always%20commemorated). The code compares these ranks:
    - The highest rank “wins” as the office of the day.
    - If the secondary feast is of sufficiently high rank that it would traditionally be commemorated (e.g., III class or higher in 1960, or any simple feast in older rubrics if not outranking), it will be included as a commemoration. The documentation notes, for instance, that any observance of rank above a certain threshold (like above “3rd order” ~ rank 4.2) is “always commemorated” when it loses precedence [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=II.%20classis%20%28Trid.%20pre,This%20and%20above%20always%20commemorated).
    - Some special rules apply for concurrence of two feasts in the evening (Vespers). The code likely checks if an occurring feast causes I Vespers or II Vespers conflicts. For example, if a feast tomorrow outranks today’s, you pray First Vespers of tomorrow instead of Second Vespers of today, etc. This would be handled by looking at evening of previous/next day ranks. (There is an ordo.pl output that lists these details, suggesting the logic covers Vesperal concurrence as well.)

The result of this step is that the script decides which file to use as the primary office and whether to include a secondary file as a commemoration. It sets internal flags for things like “this is a Sunday so omit Gloria” or “today Te Deum is said,” etc., based on the rank and rubrics.

4. Handle Special Rules from the Proper File: After determining the main office file, the code reads its content (and that of any commemoration file). Many proper files contain a [Rule] section enumerating exceptions to the normal structure for that particular feast [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Many%20of%20the%20files%20in,Rule%5D%20item%20looks%20like). For example, a saint’s file might have:
    ```
    [Rule]
    ex C4;
    9 lectiones
    Te Deum
    ```
This could mean: “Take everything that is not provided in this proper from the Common ‘C4’ (Common of Confessor Bishop)”; “Use 9 readings (three nocturns) at Matins instead of the usual 3”; “Sing the Te Deum”, etc. [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Many%20of%20the%20files%20in,Rule%5D%20item%20looks%20like) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=omit%C2%A0group%20list%20Skip%20the%20named,31). The code will interpret these rules. Some common [Rule] directives include:

- ex {file}; – Use an external file as a source for any parts not in this proper. For example ex C2; means fill from Common of one Martyr if this proper lacks some parts [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Each%20rule%20is%20a%20separate,14). It can also point to a Temporale or another specific Proper file (ex Sancti/05-08 etc.) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Each%20rule%20is%20a%20separate,14).
- vide {file}; – Similar to ex, but only borrow certain parts (usually Matins readings and Lauds/Vespers antiphons & oration) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=ex%C2%A0Pasc0,02). This is used when, say, a feast uses the common for most parts but has its own collect or other peculiarities.
- Psalm and Hymn directives: e.g. Psalmi Dominica means use the Sunday psalmody instead of proper/festal psalms [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=vide%C2%A0file%20like%20above%2C%20but%20only,02); Psalmi minores ex Psalterio means use the weekday (ferial) psalms for the Little Hours [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=mtv%20Changing%20the%20third%20verse,02); instructions like Hymnus may indicate which hymn variant to use (some feasts change the third verse of Iste Confessor – indicated by mtv rules) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=ex%C2%A0Pasc0,02).
- Flags like 9 lectiones or 12 lectiones signal how Matins should be configured (three nocturns vs. one) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Sancti%2F01,06). For example, on a I Class feast you have 3 nocturns (9 readings) even under 1960 rubrics which normally have 3; the file will have this to force the older format if needed.
- Other special indicators: Feria Te Deum (even though it’s a feria, say Te Deum – used for certain joyful ferias) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=indicated%20as%20being%20proper%20in,02); Festum Domini (a Feast of the Lord, under 1960 rules, outranks a Sunday) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Feria%C2%A0Te%C2%A0Deum%20Te%20Deum%20is%20sung,02); Antiphonas horas (use the Lauds antiphons also at Prime, Terce, Sext, None) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,Antiphones%20horas%209%20lectiones) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Festum%C2%A0Domini%20Under%20Rubrics%201960%2C%20such,used%20for%20the%20minor%20hours); etc.
- The code horascommon.pl and special.pl process these rules. They might load the referenced “common” file into a secondary hash and mark that any missing sections in the main file should be pulled from the common. The Antiphonas horas rule in the example [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Festum%C2%A0Domini%20Under%20Rubrics%201960%2C%20such,used%20for%20the%20minor%20hours) is handled by a hard-coded understanding: it means the Little Hours will not have their own antiphons, but reuse Lauds antiphons 1, 2, 3, 5 for Prime, Terce, Sext, None respectively [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Festum%C2%A0Domini%20Under%20Rubrics%201960%2C%20such,used%20for%20the%20minor%20hours).
- These rules essentially fine-tune the content selection after the main feast is chosen.

5. Output flags: The calendar logic also sets up contextual information for the output – e.g. what season it is (for seasonal headings), what the class of day is (to display in the GUI), what commemorations to list, etc. It likely populates global variables or data structures that the display scripts use to print headings like "XX Sunday after Pentecost – Commemoration of St. XYZ, Martyr" etc.

By the end of horascommon.pl execution for a given date, the program has determined:
- The primary office file (and thus which propers to use),
- Any commemorations (additional file to load limited parts from),
- The applicable common (if the proper has an ex rule or if it’s a ferial day that needs to borrow from the Psalter or a transferred vigil, etc.),
- The adjustments like “use Vespers of following” or “two nocturns vs. one”, etc., as well as any variable elements (like specific Marian antiphon for the season, proper doxology for hymns if indicated by a rule or the presence of an octave, etc.). All these are stored for use in rendering.

Notably, the same fundamental calendar logic applies to the Missal as well. The Mass of the day is generally the same feast as the Office, with a few exceptions. One documented exception is a Vigil in Advent that is only celebrated at Mass but not in the Office: the tables list a rank “Vigilia in Adventu (ad Missam) 2.5” used “only for Missa when Office is of the Feria but Mass of the Vigil.” [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=match%20at%20L244%20Vigilia%20in,19). In such a case, the code would detect that scenario (likely via the rank and rules) and ensure that while the breviary uses the ferial office, the Missal output uses the propers of the Vigil. In implementation, this might mean the Missal script calls the same calendar logic but with a flag or it performs a second check for these special cases. Overall, the Mass calendar is kept in sync with the Office calendar, using the same Kalendaria entries and rank comparisons [source](https://github.com/DivinumOfficium/divinum-officium/discussions/3993#:~:text=2,g), but with some conditional differences (like which rank outranks what for Mass versus Office). Indeed, the maintainers have discussed unifying the data so that “every office/mass has its designated file and there are no divergences in [Rank]” between them [source](https://github.com/DivinumOfficium/divinum-officium/discussions/3993#:~:text=for%20decision%20making%20on%20the,to%20be%20stacked%20on%20Latin).

## Assembling the Divine Office (Horas)

Once the liturgical day’s variables are determined, Divinum Officium generates the content of each canonical hour. The main script for the desktop web interface is officium.pl, and for the mobile interface is Pofficium.pl (a pared-down version for phones) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,also%20calls%20upon%20other%20scripts). These scripts create the HTML page and coordinate calls to other modules. The general flow for producing the Office page is:

1. UI Setup: officium.pl (desktop) produces the overall page structure – for example, it might print the title, navigation links (like “Next/Prev Day”), and a form for user options. It uses dialogcommon.pl and setup.pl to handle user preferences (language selection, calendar version, whether to show all hours or one at a time, etc.) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Auxiliary%20Perl%20Scripts%20,files%20for%20the%20web%20versions). The dialog is the part of the page with drop-downs or checkboxes for settings, and these helper scripts manage reading cookies and generating the HTML form elements [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Auxiliary%20Perl%20Scripts%20,files%20for%20the%20web%20versions).
2. Date and Office Calculation: officium.pl will invoke horascommon.pl to compute the office for the selected date (as detailed earlier). This sets up global structures with the names of the files to use and relevant flags for the day [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Main%20Perl%20Scripts%20,and%20provides%20rules%20for%20precedence).
3. Loading Texts: The program then loads the content of the necessary text files (for the selected language(s)):
    - The primary proper file (from Tempora or Sancti as determined).
    - Any commemoration file (if one was determined).
    - The applicable Common file (if the proper has ex … or similar rule).
    - The relevant Ordinarium file for each hour (these act as templates; they are not loaded into hashes but read line by line when printing).
    - The Psalterium files as needed (e.g., if using the common Psalms or hymns from the Psalterium, those sections will be fetched).
    - The code likely stores all loaded textual data in in-memory hashes keyed by language and file, or loads them on the fly when special.pl requests a section.

4. Generating Hour by Hour: For each hour to be displayed, the script horas.pl is used. horas.pl “interprets the special characters and prints out the Officium for the selected hour.” [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Main%20Perl%20Scripts%20,and%20provides%20rules%20for%20precedence) Essentially, for a given Hour (Matins, Lauds, Prime, etc.), horas.pl will:
    - Open the corresponding Ordinarium template (e.g. Ordinarium/Laudes.txt for Lauds).
    - Iterate through each line. Lines starting with # indicate a major section boundary or item in the hour’s order [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,usually%20printed%20in%20the%20Ordinarium). When it sees a # SectionName, the script delegates to special.pl to “fill up the skeleton chapters with actual content from the databases.” [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Main%20Perl%20Scripts%20,and%20the%20office%20for%20any). In other words, special.pl handles replacing that placeholder with the actual prayers/text.
    - special.pl uses the previously loaded hashes of the day’s proper(s), the commons, psalter, etc., to find the text corresponding to that section. For example, when processing # Capitulum at Vespers, special.pl will determine which Capitulum to print: if the proper file has a [Capitulum Vespera] it will use that; if not, it might fall back to a common or ferial capitulum according to the rules. It also processes the special symbols in those texts (like !, @ references, etc. described earlier) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,the%20line%20with%20red%20font). Cross-references (@) cause it to retrieve text from other files/hashes as needed – e.g., if the proper says @Commune/C4:Ant 1, it will fetch Antiphon 1 from the Common C4 file.
    - Lines in the Ordinarium starting with $ or & trigger their respective behaviors (inserting prayers from Prayers.txt or executing a subroutine) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=earlier.%20,will%20refer%20to%20the%20Lauds). For example, $Pater noster might be a placeholder that prints the Our Father (from the Prayers file) with a special formatting (and possibly as a clickable text for a popup) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=earlier.%20,will%20refer%20to%20the%20Lauds).
    - Ordinary texts embedded in the Ordinarium (not marked by any special char) are output as-is (for example, the opening versicles “℣. Deus, in adjutorium meum intende…” might be directly in the Lauds Ordinarium file).
    - horas.pl arranges everything into an HTML table structure. Typically, Divinum Officium outputs each prayer or psalm in a table row (with alternating colors or styles). The special markers like double line breaks and _ underscore help horas.pl know when to end a table cell or insert an empty cell [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,text%20in%20small%20red%20font). As a result, the page is neatly formatted with distinct blocks for Antiphons, Psalms, readings, responsories, etc.
    - If the user requested “All Hours” on one page, officium.pl simply calls horas.pl for each hour in sequence, producing the full day’s office. If only one hour is requested (or on mobile), it would call it for that hour alone. (The mobile script Pofficium.pl likely only shows one hour at a time with navigation to switch hours, to keep pages shorter on small screens.)

5. Pop-ups and Interactive Elements: The script webdia.pl is used to generate certain reusable HTML snippets like the option tables or to attach popup windows functionality [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Auxiliary%20Perl%20Scripts%20,files%20for%20the%20web%20versions). For example, elements marked by $ that correspond to prayers can be made clickable to show the full text in a small window. Similarly, Scripture readings might be clickable to see a parallel translation if the user enabled it. The code writes JavaScript or simple window links for these. popup.pl is a script that outputs the content for such a popup if triggered [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=office%20tables%2C%20and%20also%20reads%2Fwrites,files%20for%20the%20web%20versions) (for instance, the full text of Psalm 94 if a user clicks “Invitatory Psalm” might be handled this way).

Throughout this process, the conditional logic embedded in the text files is also respected. The data files contain conditional instructions in Latin (within parentheses) to handle variations. The technical manual describes a mini-language with stopwords like si, vero, sed, attamen etc., and instructions like “omititur” (it is omitted) or “dicitur” (it is said) with specified scope [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Conditionals) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=hi%20versus%20,semper%29%20omittitur%20omittuntur). For example, an antiphon might be marked “(si Dominica) … dicitur” meaning “if it is Sunday, this is said,” or “(sed Feria VI) omittitur” meaning “but if it’s Friday, it is omitted.” The code in special.pl parses these conditions and will include or skip text accordingly, based on the current context (it knows the day of week, the rubric set, whether it’s a festal office or not, etc.) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20database%20files%20contain%20various,si%20deinde%20vero%20sed) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Conditions%20can%20be%20broken%20into,must%20not%20be%20true). The conditions can have forward or backward scope (affecting adjacent lines or entire blocks) and complex logical connectors (et, aut, nisi) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Conditions%20can%20be%20broken%20into,must%20not%20be%20true) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20instructions%20,depends%20on%20the%20scope%20descriptor). This system is how a single Ordinarium file can handle both say, the regular Compline and special rules for Compline in the Triduum (which might omit certain parts) by wrapping those parts in conditionals.

In summary, the Horas generation involves using horascommon to decide what to say, and horas.pl/special.pl to decide how to say it and print it, by pulling the right texts and applying formatting. The outcome is a fully assembled Office for the day, with all the correct prayers, readings, and rubrics for the chosen calendar version.

## Implementing the Missal (Mass) Output

The Missal side of the project operates on analogous principles, though its implementation details mirror the structure of the Mass. The main script is missa.pl, which corresponds to the “Sancta Missa” section of the site (accessible via the Missale link or cgi-bin/missa/missa.pl) [source](https://stclement-ottawa.org/en/todays-readings-livestream-link/#:~:text=Today%27s%20Readings%20%2F%20Livestream%20Link,bin%2Fhoras%2Fofficium.pl.%20This). This script likely calls the same underlying logic in horascommon.pl (or a similar missacommon.pl) to determine the day’s Mass, since the Office and Mass calendars are synchronized. After determining the day’s celebration and any commemorations, the Mass assembly goes through steps similar to the Office:
- Choosing Propers: The program identifies the proper Mass file for the day (from the Tempora or Sancti folders under missa/Language/...). For example, if the Office determined today is the feast of St. Hyginus (commemorated) within the feria of Epiphany Octave, then for Mass it knows the main Mass is of the feria (6th Day in Octave) and a commemoration of St. Hyginus. The Mass files for these would be something like Tempora/Epi1-6.txt (assuming Epiphany octave day 6 is stored there) and Sancti/01-11cc.txt or similar for St. Hyginus’s orations if commemorated (or possibly the full St. Hyginus Mass if it exists). The key difference in the Missal is that often the Collect, Secret, and Postcommunion prayers of a commemorated feast are added after those of the main Mass. The code will handle that by appending those sections from the commemoration file after printing the main ones.
- Mass Ordinary and Structure: The Mass has a fixed Ordinary (Kyrie, Gloria, Credo, etc.) and variable Propers. The project likely has an Ordinary of the Mass text somewhere (perhaps in a file or constructed from sources) which includes the unchanging parts (with slight variations for certain seasons, e.g., the Gloria is omitted in penitential times, the Creed is included on certain days, etc.). The Missal script would need to intersperse the proper texts at the right points of the Ordinary:

    1. Introit – proper (from the day’s file, [Introit]).
    2. Kyrie – part of Ordinary (though note, some feasts have proper troped Kyries, but those are extremely rare in 1962 or earlier – usually Kyrie is standard).
    3. Gloria – Ordinary (but only if the rubrics of the day call for it; the code checks the rank or season to decide if Gloria is said).
    4. Collect (Oratio) – proper (and if a commemoration exists, after the main collect, the commemorations’ Collect(s) are added). The program may print a header like “Commemoratio S. N.” and then the collect from that saint’s file.
    5. Epistle/Lesson – proper (from [Lectio] or sometimes multiple readings if a special Mass).
    6. Gradual/Alleluia/Tract – proper (often two sections: e.g. [Graduale] and [Alleluia] or [Tractus] depending on season).
    7. Gospel – proper ([Evangelium] section).
    8. Offertory Antiphon – proper ([Offertorium]).
    9. Secret – proper ([Secreta]), likewise followed by any commemoration Secret(s) if applicable.
    10. Preface – part of Ordinary (the text of the Preface is fixed per season/feast; the site might not print the entire Canon for brevity or might just name the Preface).
    11. Canon of the Mass – Ordinary (generally not printed in full for each Mass on the site, except maybe in some modes; Divinum Officium might not include the fixed Canon text every time, or perhaps it does if the user selects it).
    12. Communion Antiphon – proper ([Communio]).
    13. Postcommunion – proper ([Postcommunio]), plus any commemoration postcommunions.
    14. Ite, missa est/Last Gospel – Ordinary (the dismissal varies if Alleluia is added during Easter, etc., and Last Gospel is usually fixed John 1, which might not be printed out each time).

The assembly would be handled in a way analogous to how the Office is assembled: there might be an “Ordinarium Missae” file listing the sequence, and the code fills in the Propers at the placeholders. In the Credits, it’s mentioned “For the Ordinary of the Mass, we have used resources… The Propers are taken from…” [source](https://www.divinumofficium.com/www/horas/Help/credits.html#:~:text=Credits%20,from%20Iglesia%20de%20El) [source](https://www.divinumofficium.com/www/horas/Help/credits.html#:~:text=Parts%20of%20the%20Mass%20Ordinary,NSPJ%20w%20Bydgoszczy%20page), implying the data is indeed present to print the ordinary prayers (at least the text of Kyrie, Gloria, Credo, etc., presumably in Latin and maybe translations). If not printed in full every time, the site may provide a link to the Ordinary. But given that one can use Divinum Officium to follow the Mass, it’s likely all text is available through the interface.

- Rubrical adjustments for Mass: The Missal side also obeys rules like:
    - Gloria/Credo omitted or said: These are determined by the rank of the day (e.g., Gloria is omitted in Advent ferias, but said on feasts; Creed is said on Sundays and 1st/2nd class feasts, etc.). The program must know the classification of the day and insert or skip these parts accordingly.
    - Preface selection: Possibly handled by a lookup (the proper file might include a hint like a Preface tag or the program knows by season/feast which preface to note).
    - Vestment color or other indications: The site might not explicitly show color, but the rank name often encodes it. (The Ordo output does list color sometimes.)
    - Multiple Collects (Orationes) for commemorations: as noted, if a saint is commemorated, the code prints the additional prayers. The data likely has the commemorated saint’s file with those prayers ready. For example, St. Hyginus’s file would have an [Oratio] which gets used as a commemorative Collect, [Secreta] as commemorative Secret, etc. The ordering in the Missal output is all main prayers first, then all commemoration prayers. Divinum Officium’s data and code ensure this order is followed (they have internal flags for how many collects to print, etc.).
    - Antiphon duplication issues: A nuance from the GitHub discussions: they aim to eliminate duplicate text by using reference labels in the data (for instance, many Masses share the same Collect as another feast). The program can handle references like @[Common|Tempora file]:Oratio in the Missal data similar to how the Office does for psalms and such [source](https://github.com/DivinumOfficium/divinum-officium/discussions/3993#:~:text=5,labels). So if a vernacular version doesn’t have a translation for a prayer but the Latin does, it might reference English or Latin text rather than copy it, and the code will follow that reference. Ensuring the correct inheritance of text (Latin -> English -> other languages) is part of the data handling logic [source](https://github.com/DivinumOfficium/divinum-officium/discussions/3993#:~:text=be%20more%20pressing%20for%20the,the%20Breviary%20at%20the%20moment).

In essence, missa.pl would be structured comparably to officium.pl: it sets up the page, calls the common routine to figure out the day’s Mass, then uses a specialized routine (let’s call it missa.pl itself or a helper) to print the parts of Mass in order, drawing on the data files. If Divinum Officium’s Office engine is considered complex, the Missal is somewhat simpler in structure (no multiple hours, but still multiple parts). The code, however, had to integrate Missal data later, and maintainers note “the missa database is not as well kept as the horas” and long-term they want to merge them more [source](https://github.com/DivinumOfficium/divinum-officium/discussions/3993#:~:text=for%20decision%20making%20on%20the,Rank%5D%60%20and%20Commemorations%20etc) – implying that currently Missal might have some separate handling but largely parallels the Office code design.

## Conclusion

Divinum Officium’s implementation can be seen as a large expert system encoding the 1962 and earlier liturgical rules. The core approach is highly data-driven: almost every piece of text and rule is externalized in configuration files (Kalendaria, Transfer tables, text files with conditional sections). The Perl scripts parse these and apply the intricate logic of the traditional Roman Rite’s calendar (occurrences, concurrences, commemorations, class of feasts, etc.) to decide which texts to display. Then they assemble the liturgical texts by merging the fixed templates (Ordinarium/Ordinary) with the proper parts for the specific day, resolving cross-references and conditional rubrics on the fly.

For a modern re-implementation, one would mimic this flow:

- Parse the calendar tables to know the hierarchy of feasts for each day.
- Determine precedence rules by comparing ranks and using the transfer rules (which may involve computing Easter and the Dominical Letter – standard calendar calculations).
- Load the relevant texts from data (preferably reusing the existing .txt files for authenticity) and apply any rules ([Rule] directives).
- Compose the Office/Mass by following an order of worship template and plugging in the texts, observing the special formatting instructions.

The existing documentation and code, while in Perl, provide a comprehensive blueprint of the logic. By following the same data structures – e.g., reading the bracketed sections into dictionaries, evaluating the conditionals and special tokens – one can achieve identical behavior in a modern language or framework. In fact, the technical manual was written to facilitate exactly that, by revealing how “Divinum Officium and Sancta Missa are internally structured” and giving developers the freedom to reuse these ideas in new implementations [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=This%20part%20of%20the%20help,others%20to%20the%20same%20ideas). The key is to faithfully implement the liturgical decision-making (calendar) and the assembly of texts as described above. With that in place, the output of a modern system will match the rich, exact output of Divinum Officium – ensuring that the liturgical calendar, the Horas, and the Missal are presented with the same accuracy and traditional fidelity.

Sources:

- Divinum Officium Technical Manual – Project help pages detailing data structures and program flow [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20top%20level%20folders%20are,folder%20of%20that%20language%20first) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=The%20files%20itself%20usually%20are,Capitulum%20Nona%5D%2C%20etc) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Meaning%20is%20explained%20in%20example,Divino%20Afflatu%20is%20used%20as) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=,Special%20characters) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Main%20Perl%20Scripts%20,and%20provides%20rules%20for%20precedence), etc.
- Divinum Officium GitHub README – Notes on data file locations and usage [source](https://github.com/DivinumOfficium/divinum-officium#:~:text=Data%20files).
- Divinum Officium GitHub discussions – Insights on Missal data vs. Breviary data management [source](https://github.com/DivinumOfficium/divinum-officium/discussions/3993#:~:text=be%20more%20pressing%20for%20the,the%20Breviary%20at%20the%20moment) [source](https://github.com/DivinumOfficium/divinum-officium/discussions/3993#:~:text=for%20decision%20making%20on%20the,to%20be%20stacked%20on%20Latin).
- Divinum Officium site credits – Sources of texts for Ordinary and Propers [source](https://www.divinumofficium.com/www/horas/Help/credits.html#:~:text=Parts%20of%20the%20Mass%20Ordinary,NSPJ%20w%20Bydgoszczy%20page).
- Live data examples from Kalendaria and Transfer tables in Technical Manual [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=Meaning%20is%20explained%20in%20example,signs%20are%20comments) [source](https://www.divinumofficium.com/www/horas/Help/technical.html#:~:text=%6001,but%20without%20the%20aforementioned%20commemoration).