generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// -----------------------------
// RITES AND VERSIONS
// -----------------------------
model Rite {
  id          Int           @id @default(autoincrement())
  name        String        @unique // e.g. "Roman", "Ambrosian"
  description String?
  versions    RiteVersion[]
}

model RiteVersion {
  id          Int       @id @default(autoincrement())
  slug        String    @unique // e.g. "rom1962", "rom1970", "rom2002"
  name        String
  promulgated DateTime? // promulgation date if known
  notes       String?

  riteId Int
  rite   Rite @relation(fields: [riteId], references: [id])

  // Self-relation for inheritance
  parentId Int?
  parent   RiteVersion?  @relation("RiteVersionParent", fields: [parentId], references: [id])
  children RiteVersion[] @relation("RiteVersionParent")

  movableFeasts MovableFeast[]
  fixedFeasts   FixedFeast[]
  seasonalDays  SeasonalDay[]
  season        Season[]
  rank          Rank[]
}

// ----------------------------------------------------------
// CALENDAR
// ----------------------------------------------------------
model Season {
  id            Int           @id @default(autoincrement())
  key           String // e.g., "Quadragesimae"
  latinName     String
  vernacular    String? // optional English name
  color         String? // liturgical color (e.g., "violet")
  description   String?
  riteVersionId Int
  riteVersion   RiteVersion   @relation(fields: [riteVersionId], references: [id])
  SeasonalDay   SeasonalDay[]

  @@unique([key, riteVersionId])
}

model Rank {
  id            Int            @id @default(autoincrement())
  key           String // e.g., "sollemnitas", "festum duplex majus"
  latinName     String
  vernacular    String?
  precedence    Int? // numeric hierarchy, e.g., 1=highest
  description   String?
  riteVersionId Int
  riteVersion   RiteVersion    @relation(fields: [riteVersionId], references: [id])
  MovableFeast  MovableFeast[]
  FixedFeast    FixedFeast[]
  SeasonalDay   SeasonalDay[]

  @@unique([key, riteVersionId])
}

model MovableFeast {
  id               Int     @id @default(autoincrement())
  key              String  @unique
  name             String
  offsetFromEaster Int
  description      String?

  riteVersionId Int
  riteVersion   RiteVersion @relation(fields: [riteVersionId], references: [id])
  rankId        Int
  rank          Rank        @relation(fields: [rankId], references: [id])

  horae  Hora[]
  missae Missa[]

  @@unique([key, riteVersionId])
}

model FixedFeast {
  id          Int     @id @default(autoincrement())
  key         String  @unique
  name        String
  month       Int
  day         Int
  description String?

  riteVersionId Int
  riteVersion   RiteVersion @relation(fields: [riteVersionId], references: [id])
  rankId        Int
  rank          Rank        @relation(fields: [rankId], references: [id])

  horae  Hora[]
  missae Missa[]

  @@unique([key, riteVersionId])
}

model SeasonalDay {
  id          Int            @id @default(autoincrement())
  key         String         @unique
  weekNumber  Int
  weekday     DiesHebdomadis
  description String?

  riteVersionId Int
  riteVersion   RiteVersion @relation(fields: [riteVersionId], references: [id])
  rankId        Int
  rank          Rank        @relation(fields: [rankId], references: [id])
  seasonId      Int
  season        Season      @relation(fields: [seasonId], references: [id])

  horae  Hora[]
  missae Missa[]

  @@unique([key, riteVersionId])
}

enum DiesHebdomadis {
  Dominica
  FeriaSecunda
  FeriaTertia
  FeriaQuarta
  FeriaQuinta
  FeriaSexta
  Sabbatum
}

/**
 * ================================================================
 * UNIVERSAL TEXT CORPUS
 * ================================================================
 */

model TextSource {
  id          Int     @id @default(autoincrement())
  code        String  @unique // "VULG", "AUG_SERM", etc.
  title       String
  author      String?
  language    String // ISO code: "la", "en", etc.
  category    String? // "Scripture", "Patristic", "Conciliar", etc.
  description String?

  sections TextSection[] // every source has ≥1 section
  TextUnit TextUnit[]
  RefBlock RefBlock[]
}

model TextSection {
  id           Int        @id @default(autoincrement())
  textSourceId Int
  textSource   TextSource @relation(fields: [textSourceId], references: [id])

  title    String
  code     String? // "GEN", "JOH", "MAIN", etc.
  order    Int? // canonical order within source
  parentId Int?
  parent   TextSection?  @relation("TextSectionParent", fields: [parentId], references: [id])
  children TextSection[] @relation("TextSectionParent")

  units TextUnit[]

  @@unique([textSourceId, code])
  @@index([textSourceId, order])
}

model TextUnit {
  id           Int         @id @default(autoincrement())
  textSourceId Int
  textSource   TextSource  @relation(fields: [textSourceId], references: [id])
  sectionId    Int
  section      TextSection @relation(fields: [sectionId], references: [id])

  sequence       Int // stable monotonic order
  label          String? // "John 3:16", "§12", etc.
  text           String
  refExternal    String? // optional external URI or key
  startRefBlocks RefBlock[] @relation("Start")
  endRefBlocks   RefBlock[] @relation("End")

  @@unique([sectionId, sequence])
  @@index([textSourceId, sectionId, sequence])
}

/**
 * ================================================================
 * CHANT SOURCES / USAGE (aligned to GregoBase)
 * ================================================================
 */

model ChantSource {
  id    Int    @id @default(autoincrement())
  code  String @unique // e.g. "AR1949", "AM1934", "GR1908"
  title String // e.g. "Antiphonale Romanum"
  year  Int // publication year 

  // Helpful bibliographic bits (keep both; see explanation below)
  editor    String? // editor / monastic house / responsible party
  publisher String? // publishing house / imprint

  gabcSources GabcSource[]
}

model ChantUsage {
  id          Int          @id @default(autoincrement())
  key         String       @unique // exactly GregoBase “by usage”, e.g. "Antiphona"
  label       String // display label (same as key or localized)
  gabcSources GabcSource[]
}

model GabcSource {
  id   Int    @id @default(autoincrement())
  name String // chant title as printed in edition
  mode String // I–VIII, "per.", etc.
  gabc String // full GABC notation text

  chantSourceId Int
  chantSource   ChantSource @relation(fields: [chantSourceId], references: [id])
  chantUsageId  Int
  chantUsage    ChantUsage  @relation(fields: [chantUsageId], references: [id])

  textBlock      TextBlock?    @relation(fields: [textBlockId], references: [id])
  textBlockId    Int?
  chantBlock     ChantBlock?   @relation(fields: [chantBlockId], references: [id])
  chantBlockId   Int?
  responsePart   ResponsePart? @relation(fields: [responsePartId], references: [id])
  responsePartId Int?

  @@index([chantSourceId])
  @@index([chantUsageId])
}

/**
 * ================================================================
 * LITURGICAL BUILDING BLOCKS
 * ================================================================
 */

model ActusLiturgicus {
  id     Int    @id @default(autoincrement())
  action String
}

model TextBlock {
  id    Int     @id @default(autoincrement())
  text  String
  title String?

  genusId Int
  genus   TextBlockGenus @relation(fields: [genusId], references: [id])

  gabcVariants GabcSource[] // optional, for sung versions
}

model TextBlockGenus {
  id          Int    @id @default(autoincrement())
  name        String // e.g. "Collecta", "Postcommunio"
  description String

  textBlocks TextBlock[]
}

model RefBlock {
  id       Int     @id @default(autoincrement())
  title    String?
  seqStart Int // cached startUnit.sequence
  seqEnd   Int // cached endUnit.sequence

  refBlockGenusId Int
  refBlockGenus   RefBlockGenus @relation(fields: [refBlockGenusId], references: [id])
  textSourceId    Int
  textSource      TextSource    @relation(fields: [textSourceId], references: [id])

  startUnitId Int
  startUnit   TextUnit @relation("Start", fields: [startUnitId], references: [id])
  endUnitId   Int
  endUnit     TextUnit @relation("End", fields: [endUnitId], references: [id])
}

model RefBlockGenus {
  id          Int    @id @default(autoincrement())
  name        String // e.g. "Psalm", "Reading"
  description String

  refBlocks RefBlock[]
}

model ChantBlock {
  id    Int     @id @default(autoincrement())
  title String
  text  String
  tone  String? // e.g. "VIII G", "IV a", "peregrinus", optional for non-psalmodic chants

  chantBlockGenusId Int
  chantBlockGenus   ChantBlockGenus @relation(fields: [chantBlockGenusId], references: [id])

  // Associated chant variants BY SOURCE, not usage. 
  // This list will contain versions of a particular antiphon across multiple chant sources
  // ie. feria II in Advent in Antiphonale Romanum 1949, Monasticum etc...
  // This list WILL NOT contain versions of a particular antiphon as a related to liturgical function
  // ie. NOT A LIST LIKE THIS: feria II in Advent, feria II in lent, feria II in post pentecost etc
  gabcVariants GabcSource[]
}

model ChantBlockGenus {
  id          Int    @id @default(autoincrement())
  name        String // e.g. "Psalm", "Reading"
  description String

  chantBlocks ChantBlock[]
}

model ResponseSequence {
  id          Int                  @id @default(autoincrement())
  title       String
  description String?
  kind        ResponseSequenceKind @default(Other)

  parts ResponsePart[]
}

enum ResponseSequenceKind {
  Responsory
  Versicle
  Benediction
  Dismissal
  Other
}

model ResponsePart {
  id                 Int              @id @default(autoincrement())
  responseSequenceId Int
  responseSequence   ResponseSequence @relation(fields: [responseSequenceId], references: [id])

  order        Int
  label        String? // e.g. "V.", "R.", "R’", "Chorus", "Amen", "Officiant"
  text         String
  gabcVariants GabcSource[]
}

enum BlockTable {
  ActusLiturgicus
  TextBlock
  RefBlock
  ChantBlock
  ResponseSequence
}

/**
 * ================================================================
 * HORA STRUCTURE
 * ================================================================
 */
model Hora {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  // Link Hora to calendar entities
  fixedFeastId   Int?
  fixedFeast     FixedFeast?   @relation(fields: [fixedFeastId], references: [id])
  movableFeastId Int?
  movableFeast   MovableFeast? @relation(fields: [movableFeastId], references: [id])
  seasonalDayId  Int?
  seasonalDay    SeasonalDay?  @relation(fields: [seasonalDayId], references: [id])

  elements HoraElement[] // ordered components of the Hour
}

model HoraElement {
  id     Int  @id @default(autoincrement())
  horaId Int
  hora   Hora @relation(fields: [horaId], references: [id])

  order Int // order of appearance within the Hour

  // The polymorphic reference
  blockType BlockTable // identifies which table the element points to
  blockId   Int // ID in that table
}

/**
 * ================================================================
 * MISSAL STRUCTURE
 * ================================================================
 */
model Missa {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  fixedFeastId   Int?
  fixedFeast     FixedFeast?   @relation(fields: [fixedFeastId], references: [id])
  movableFeastId Int?
  movableFeast   MovableFeast? @relation(fields: [movableFeastId], references: [id])
  seasonalDayId  Int?
  seasonalDay    SeasonalDay?  @relation(fields: [seasonalDayId], references: [id])

  elements MissaElement[] // ordered components of the Mass
}

model MissaElement {
  id      Int   @id @default(autoincrement())
  missaId Int
  missa   Missa @relation(fields: [missaId], references: [id])

  order Int // order of appearance within the Mass

  blockType BlockTable // identifies which table the element points to
  blockId   Int // ID in that table
}
